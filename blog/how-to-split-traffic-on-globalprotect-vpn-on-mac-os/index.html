<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>How to split traffic on GlobalProtect VPN on Mac OS | Jozo</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://jozo.io/blog/how-to-split-traffic-on-globalprotect-vpn-on-mac-os/">
<link rel="icon" href="../../assets/img/favicon.ico" sizes="16x16">
<link rel="icon" href="../../assets/img/favicon-32x32.png" sizes="32x32">
<link rel="icon" href="../../assets/img/favicon-512x512.png" sizes="512x512">
<!--[if lt IE 9]><script src="../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><meta name="author" content="Jozo Gaborik">
<link rel="prev" href="../structure-of-ansible-project/" title="Structure of Ansible project" type="text/html">
<link rel="next" href="../who-knocks-on-my-servers/" title="Who knocks on my servers?" type="text/html">
<meta property="og:site_name" content="Jozo">
<meta property="og:title" content="How to split traffic on GlobalProtect VPN on Mac OS">
<meta property="og:url" content="https://jozo.io/blog/how-to-split-traffic-on-globalprotect-vpn-on-mac-os/">
<meta property="og:description" content="Recently the company I work for started to use Palo Alto's GlobalProtect as solution for VPN.
The solution works quite well but have 2 flaws by default that I don't like.


First is that GlobalProtect">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-02-13T12:57:59+02:00">
<meta property="article:tag" content="mac-os">
<meta property="article:tag" content="privacy">
<meta property="article:tag" content="vpn">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
          <header id="header"><div class="inner">
        <h1 id="brand"><a href="../../" title="Jozo" rel="home">

      Jozo<span>blog</span>
  </a></h1>

      
        <nav id="menu"><ul>
<li><a href="../../archive.html">Archive</a></li>
          <li><a href="../../categories/">Tags</a></li>

      
      
      
      <li><a href="../rss.xml" title="RSS feed"><i class="fas fa-rss"></i></a></li>
    </ul></nav>
</div>
  </header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">How to split traffic on GlobalProtect VPN on Mac OS</a></h1>

    <div class="metadata">
      <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                  Jozo Gaborik
            </span></p>
      <p class="dateline">
        <a href="." rel="bookmark">
          <time class="published dt-published" datetime="2018-02-13T12:57:59+02:00" itemprop="datePublished" title="2018-02-13 12:57">2018-02-13 12:57</time></a>
      </p>
        <p class="commentline">            <a href="#disqus_thread" data-disqus-identifier="cache/posts/2018-how-to-split-traffic-on-globalprotect-vpn-on-mac-os.html">Comments</a>


      </p>
<p><em>3 min read</em></p>
      
    </div>
    
  </header><div class="e-content entry-content" itemprop="articleBody text">
      <div>
<p>Recently the company I work for started to use Palo Alto's GlobalProtect as solution for VPN.
The solution works quite well but have 2 flaws by default that I don't like.</p>
<!-- TEASER_END -->

<p>First is that GlobalProtect agent (client) runs automatically after operating system turns on
and this behaviour can't be changed in the settings. You can find solution for it on <a href="http://richddean.com/post/147155656349/stopautostartglobalprotectvpn">other blogs</a>.</p>
<p>Second flaw is that it automatically send <em>ALL</em> of my traffic through my company's VPN.
I don't think this is beneficial for company but most importantly it goes against my privacy.
There is no need for employer to know what goes on in my traffic.</p>
<p>This article describes:</p>
<ul>
<li>How to split traffic based on IP addresses</li>
<li>How to do traffic splitting automatically after GlobalProtect agent connects to VPN</li>
</ul>
<p>I will only focus on Mac OS but similar steps can be taken also on other operating systems.</p>
<h3>Traffic split with GlobalProtect</h3>
<p>When you connect to VPN with GlobalProtect, it creates new network interface
and edits the routing table so all our traffic is sent through this new network interface.</p>
<p>To solve this we need to remove a route created by GlobalProtect and then create
few new routes for only those IP addresses which we want to be directed through our VPN.</p>
<p>We implemented it in Python (based on this <a href="https://www.shadabahmed.com/blog/2013/08/11/split-tunneling-vpn-routing-table">blog post</a>).
Save the script as split_vpn.py to your home folder.
Edit the lists VPN_NETS and VPN_HOSTS based on your needs. Then you can run it everytime
you want to split traffic.</p>
<pre class="code literal-block"><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">WIRELESS_INTERFACE</span> <span class="o">=</span> <span class="s1">'en0'</span>  <span class="c1"># could be different on other systems</span>
<span class="n">TUNNEL_INTERFACE</span> <span class="o">=</span> <span class="s1">'gpd0'</span>

<span class="n">VPN_NETS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'172.222'</span><span class="p">,</span>              <span class="c1"># subnets which should use VPN</span>
<span class="p">]</span>

<span class="n">VPN_HOSTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'90.131.25.244'</span><span class="p">,</span>
    <span class="s1">'90.131.25.240'</span><span class="p">,</span>        <span class="c1"># IP address which should use VPN</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">'Please, run this command with sudo.'</span><span class="p">)</span>

    <span class="n">gateway</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">((</span><span class="s1">'netstat'</span><span class="p">,</span> <span class="s1">'-nrf'</span><span class="p">,</span> <span class="s1">'inet'</span><span class="p">))</span>
    <span class="n">routes</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)[</span><span class="mi">3</span><span class="p">:]</span>

    <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">routes</span><span class="p">:</span>
        <span class="n">route</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="n">route</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">interface</span> <span class="o">==</span> <span class="n">WIRELESS_INTERFACE</span><span class="p">:</span>
            <span class="n">gateway</span> <span class="o">=</span> <span class="n">route</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">gateway</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">'Unable to determine VPN default gateway.'</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">'Resetting routes with gateway '</span> <span class="o">+</span> <span class="n">gateway</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">((</span><span class="s1">'route'</span><span class="p">,</span> <span class="s1">'-n'</span><span class="p">,</span> <span class="s1">'delete'</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">,</span> <span class="s1">'-ifscope'</span><span class="p">,</span> <span class="n">WIRELESS_INTERFACE</span><span class="p">))</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">((</span><span class="s1">'route'</span><span class="p">,</span> <span class="s1">'-n'</span><span class="p">,</span> <span class="s1">'delete'</span><span class="p">,</span> <span class="s1">'-net'</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">,</span> <span class="s1">'-iface'</span><span class="p">,</span> <span class="n">TUNNEL_INTERFACE</span><span class="p">))</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">((</span><span class="s1">'route'</span><span class="p">,</span> <span class="s1">'-n'</span><span class="p">,</span> <span class="s1">'add'</span><span class="p">,</span> <span class="s1">'-net'</span><span class="p">,</span> <span class="s1">'default'</span><span class="p">,</span> <span class="n">gateway</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Adding routes for addresses which should go through VPN.'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">VPN_NETS</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">((</span><span class="s1">'route'</span><span class="p">,</span> <span class="s1">'-n'</span><span class="p">,</span> <span class="s1">'add'</span><span class="p">,</span> <span class="s1">'-net'</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="s1">'-iface'</span><span class="p">,</span> <span class="n">TUNNEL_INTERFACE</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">VPN_HOSTS</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">((</span><span class="s1">'route'</span><span class="p">,</span> <span class="s1">'-n'</span><span class="p">,</span> <span class="s1">'add'</span><span class="p">,</span> <span class="s1">'-host'</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="s1">'-iface'</span><span class="p">,</span> <span class="n">TUNNEL_INTERFACE</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre>

<h3>Automatic traffic split after connecting to VPN</h3>
<p>Now when we have the script to split our traffic, we want it to run automatically
after we connect to VPN with GlobalProtect.
As it is stated in <a href="https://www.paloaltonetworks.com/documentation/80/globalprotect/globalprotect-admin-guide/globalprotect-clients/deploy-agent-settings-transparently/deploy-agent-settings-to-mac-clients/deploy-scripts-using-the-mac-plist">documentation</a>,
GlobalProtect agent can run commands
before connecting, after connecting and before disconnecting.</p>
<p>Follow these steps to run the script after GlobalProtect agent connects to VPN:</p>
<ol>
<li>Disable and close GlobalProtect</li>
<li>Run <code>killall cfprefsd</code>
</li>
<li>Open in editor <code>/Library/Preferences/com.paloaltonetworks.GlobalProtect.settings.plist</code>
</li>
<li>Add to the section <code>/Palo Alto Networks/GlobalProtect/Settings/</code> following <em>(edit path based on your username)</em>:</li>
</ol>
<pre class="code literal-block"><span class="nt">&lt;key&gt;</span>post-vpn-connect<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;dict&gt;</span>
        <span class="nt">&lt;key&gt;</span>command<span class="nt">&lt;/key&gt;</span>
        <span class="nt">&lt;string&gt;</span>/Users/your_usename/post_vpn_connect.sh<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;key&gt;</span>context<span class="nt">&lt;/key&gt;</span>
        <span class="nt">&lt;string&gt;</span>admin<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/dict&gt;</span>
</pre>

<ol>
<li>Add this script to your home folder and save it as <code>post_vpn_connect.sh</code>
</li>
</ol>
<pre class="code literal-block"><span class="ch">#!/bin/bash</span>
osascript -e <span class="s1">'display notification "Start" with title "VPN traffic split"'</span>

<span class="nv">DIR</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">"</span><span class="k">$(</span> dirname <span class="s2">"</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">"</span> <span class="k">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span> <span class="k">)</span><span class="s2">"</span>

<span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/split_vpn.py

<span class="nv">country</span><span class="o">=</span><span class="sb">`</span>curl ifconfig.co/country<span class="sb">`</span>

osascript -e <span class="s2">"display notification \"End. You country is </span><span class="nv">$country</span><span class="s2">\" with title \"VPN traffic split\""</span>
</pre>

<p>Now your traffic should be automatically split each time you connect to VPN with GlobalProtect. Nice!</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/mac-os/" rel="tag">mac-os</a></li>
            <li><a class="tag p-category" href="../../categories/privacy/" rel="tag">privacy</a></li>
            <li><a class="tag p-category" href="../../categories/vpn/" rel="tag">vpn</a></li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="jozo-io",
            disqus_url="https://jozo.io/blog/how-to-split-traffic-on-globalprotect-vpn-on-mac-os/",
        disqus_title="How to split traffic on GlobalProtect VPN on Mac OS",
        disqus_identifier="cache/posts/2018-how-to-split-traffic-on-globalprotect-vpn-on-mac-os.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


      </section></article><script>var disqus_shortname="jozo-io";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script></main><footer id="footer"><ul class="social">
<li><a href="http://github.com/jozo" target="_blank" title="Github"><i class="fab fa-github-alt"></i></a></li>
    <li><a href="http://gitlab.com/jozo" target="_blank" title="Gitlab"><i class="fab fa-gitlab"></i></a></li>
    <li><a href="https://stackoverflow.com/users/6634060/jozo" target="_blank" title="StackOverflow"><i class="fab fa-stack-overflow"></i></a></li>
    <li><a href="http://twitter.com/jozo_io" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a></li>
    <li><a href="https://mastodon.technology/@jozo" target="_blank" title="Mastodon"><i class="fab fa-mastodon"></i></a></li>
    <li>
<a href="http://linkedin.com/in/jozo" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a>
    </li>
  </ul>
<p><small>© 2020 <a href="mailto:hi@jozo.io">Jozo Gaborik</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a> and ♥ <small></small></small></p>
      
    </footer>
</div>
          <script src="../../assets/js/all-nocdn.js"></script><script src="https://polyfill.io/v3/polyfill.js?features=Intl.RelativeTimeFormat.%7Elocale.en"></script><script src="../../assets/js/luxon.min.js"></script><script src="https://kit.fontawesome.com/8a0d4a7b33.js" crossorigin="anonymous"></script><!-- fancy dates --><script>
    luxon.Settings.defaultLocale = "en";
    fancydates(2, {"preset": false, "format": "yyyy-MM-dd HH:mm"});
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
